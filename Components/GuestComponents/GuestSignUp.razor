@using RoadTrip.RoadTripDb.Database.Models
@using RoadTrip.RoadTripDb.Repos
@inject IGuestAppUserRepo GuestAppUserRepo
@inject ISnackbar Snackbar

<MudContainer>
    <MudCard>
        <MudCardHeader>
            <MudText Typo="Typo.h2">Sign Up To Play</MudText>
        </MudCardHeader>
        <MudCardContent>
            @if (HostId.HasValue)
            {
                <MudForm>
                    <MudTextField @bind-Value="NewGuest.DisplayName" Label="Display Name" Placeholder="Display Name"></MudTextField>
                    <MudTextField @bind-Value="NewGuest.PrimaryName" Label="Primary Name" Placeholder="Primary Name"></MudTextField>
                    <MudTextField @bind-Value="NewGuest.Surname" Label="Surname" Placeholder="Surname"></MudTextField>
                    <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Success">Join Up</MudButton>
                </MudForm>
            }
            else
            {
                <MudText Typo="Typo.h3">Sorry you must have a host available to sign up</MudText>
            }
        </MudCardContent>
    </MudCard>
</MudContainer>
@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; }
    [Parameter]
    public Guid? HostId { get; set; }
    private GuestAppUser NewGuest { get; set; } = new();

    private async Task JoinUp()
    {
        if (!HostId.HasValue)
        {
            Snackbar.Add("Navigvation error", Severity.Error);
            return;
        }

        if (string.IsNullOrWhiteSpace(NewGuest.PrimaryName) || string.IsNullOrWhiteSpace(NewGuest.Surname) || string.IsNullOrWhiteSpace(NewGuest.DisplayName))
        {
            Snackbar.Add("Failed to sign up, please fill out all fields", Severity.Warning);
        }
        else
        {
            NewGuest.HostId = HostId.Value;
            var signedUp = await GuestAppUserRepo.AddAsync(NewGuest);
            if (signedUp.GuestId != Guid.Empty)
            {
                Snackbar.Add("Successfully signed up", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to sign up, server error please contact support", Severity.Error);
            }
        }
    }

}
